<!doctype html>
<html lang="ro">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hiking & Moto Trails – Petru & Ioana</title>
  <meta name="description" content="View and download GPX tracks — hiking and moto routes">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#f4f4f5',
              100: '#e4e4e7',
              500: '#71717a',
              600: '#52525b'
            }
          }
        }
      }
    };
  </script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="min-h-screen bg-zinc-50 text-zinc-900 transition-colors duration-300 flex flex-col dark:bg-zinc-950 dark:text-zinc-50" style="font-family:'Inter',system-ui,-apple-system,sans-serif;">
  <header class="relative overflow-hidden border-b border-slate-200 bg-gradient-to-br from-zinc-50 via-white to-zinc-100 dark:border-zinc-800 dark:bg-gradient-to-br dark:from-zinc-950 dark:via-zinc-900 dark:to-zinc-900">
    <div class="absolute inset-0 opacity-50 blur-3xl bg-[radial-gradient(circle_at_20%_20%,rgba(148,163,184,.22),transparent_35%),radial-gradient(circle_at_80%_10%,rgba(161,161,170,.22),transparent_30%)] pointer-events-none"></div>
    <div class="relative mx-auto flex max-w-6xl items-center justify-between gap-6 px-4 py-6 md:px-6">
      <div class="flex flex-1 items-center gap-4 md:gap-6">
        <img src="images/petru_ioana.jpeg" alt="Petru & Ioana" class="hidden h-16 w-16 rounded-full border-4 border-white object-cover shadow-2xl md:block">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.2em] text-zinc-800 dark:text-zinc-200">GPX Routes</p>
          <h1 class="text-xl font-extrabold leading-tight text-zinc-900 drop-shadow-sm dark:text-zinc-50 md:text-2xl">Hiking & Motorcycling Adventures</h1>
          <p class="text-sm text-zinc-600 dark:text-zinc-300">Pick a route, see start/finish/parking, download GPX.</p>
        </div>
      </div>
      <button id="themeToggle" type="button" aria-label="Comută tema" class="relative inline-flex h-11 w-11 items-center justify-center rounded-full border border-slate-200 bg-white shadow-lg transition hover:-translate-y-0.5 hover:border-zinc-300 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-zinc-300 focus:ring-offset-2 dark:border-zinc-700 dark:bg-zinc-900 dark:hover:border-zinc-500 dark:focus:ring-2 dark:focus:ring-zinc-400 dark:focus:ring-offset-2 dark:focus:ring-offset-zinc-950">
        <span class="sr-only">Tema</span>
      </button>
    </div>
</header>

  <main class="mx-auto w-full max-w-6xl flex-1 px-4 py-6 md:px-6 md:py-10">
    <div class="grid gap-4 lg:grid-cols-[380px_1fr] xl:grid-cols-[420px_1fr]">
      <aside class="flex max-h-[70vh] flex-col gap-4 rounded-2xl border border-slate-200 bg-white/90 p-4 shadow-xl backdrop-blur dark:border-zinc-800 dark:bg-zinc-900/90 lg:max-h-[none]">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-lg font-bold text-zinc-900 dark:text-zinc-50">Explore the routes</h2>
            <p class="text-sm text-zinc-600 dark:text-zinc-300">Hiking & moto with GPX details and start/finish/parking points.</p>
          </div>
        </div>

        <div class="flex gap-2 rounded-xl border border-slate-200 bg-zinc-50 p-1 shadow-inner dark:border-zinc-800 dark:bg-zinc-900">
          <button data-category="hiking" class="tab-button active inline-flex flex-1 items-center justify-center gap-2 rounded-lg px-3 py-2 text-sm font-semibold text-zinc-700 transition hover:bg-white hover:shadow dark:text-zinc-200 dark:hover:bg-zinc-800">
            <i data-lucide="mountain" class="h-4 w-4"></i>
            Hiking
          </button>
          <button data-category="moto" class="tab-button inline-flex flex-1 items-center justify-center gap-2 rounded-lg px-3 py-2 text-sm font-semibold text-zinc-700 transition hover:bg-white hover:shadow dark:text-zinc-200 dark:hover:bg-zinc-800">
            <i data-lucide="bike" class="h-4 w-4"></i>
            Moto
          </button>
            </div>

        <label class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3 shadow-sm dark:border-zinc-700 dark:bg-zinc-900">
          <span class="text-sm font-medium text-zinc-700 dark:text-zinc-200">Show upcoming routes</span>
          <button id="upcomingToggle" type="button" role="switch" aria-checked="false" class="relative inline-flex h-6 w-11 items-center rounded-full bg-zinc-200 transition-colors focus:outline-none focus:ring-2 focus:ring-zinc-300 focus:ring-offset-2 dark:bg-zinc-700 dark:focus:ring-zinc-600 dark:focus:ring-offset-zinc-900">
            <span class="inline-block h-4 w-4 translate-x-1 transform rounded-full bg-white transition-transform dark:bg-zinc-200" id="upcomingToggleThumb"></span>
          </button>
        </label>

        <label class="relative block">
          <input id="search" type="search" placeholder="Search routes..." class="w-full rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm text-zinc-900 shadow-sm transition placeholder:text-zinc-400 focus:border-zinc-400 focus:outline-none focus:ring-2 focus:ring-zinc-200 dark:border-zinc-700 dark:bg-zinc-900 dark:text-zinc-50 dark:placeholder:text-zinc-500 dark:focus:border-zinc-500 dark:focus:ring-zinc-700">
          <i data-lucide="search" class="pointer-events-none absolute right-3 top-2.5 h-4 w-4 text-zinc-400 dark:text-zinc-500"></i>
        </label>

        <div id="routesList" class="flex flex-1 flex-col gap-3 overflow-auto pr-1">
          <div class="flex items-center gap-2 text-sm text-zinc-500">
            <div class="h-2 w-2 rounded-full bg-sky-400"></div>
            Loading routes...
            </div>
        </div>
    </aside>

      <section class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-white/90 shadow-2xl backdrop-blur dark:border-zinc-800 dark:bg-zinc-900/90">
        <div class="relative overflow-hidden rounded-2xl">
          <div id="map" class="h-[420px] w-full bg-zinc-100 dark:bg-zinc-900 md:h-[460px]"></div>
        </div>

        <div class="relative px-4 pb-2">
          <div class="absolute left-6 top-3 z-10 inline-flex items-center gap-2 rounded-full border border-zinc-200 bg-white px-3 py-1 text-xs font-semibold text-zinc-700 shadow-sm dark:border-zinc-700 dark:bg-zinc-900 dark:text-zinc-200">
            <i data-lucide="bar-chart-2" class="h-4 w-4"></i>
            Elevation
            </div>
          <canvas id="altitudeChart" class="h-28 w-full rounded-2xl border border-zinc-200 bg-zinc-50/80 p-2 shadow-inner dark:border-zinc-800 dark:bg-zinc-900/80"></canvas>
        </div>

        <div class="flex flex-col gap-3 border-t border-slate-200 px-4 py-4 sm:flex-row sm:items-center sm:justify-between dark:border-zinc-800">
          <div id="detailText" class="text-sm text-zinc-600 dark:text-zinc-300">Select a route to view details.</div>
          <div id="downloadWrap" class="flex flex-wrap items-center gap-3"></div>
        </div>
    </section>
</div>
  </main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
      const html = document.documentElement;
        const themeToggle = document.getElementById('themeToggle');
      const searchInput = document.getElementById('search');
      const routesList = document.getElementById('routesList');
      const detailText = document.getElementById('detailText');
      const downloadWrap = document.getElementById('downloadWrap');
      const tabButtons = document.querySelectorAll('.tab-button');

      const ROUTES_JSON = 'routes.json';
      const GPX_FOLDER = 'gpx/';
      const MAP_CENTER = [45.9432, 24.9668];

      let map;
      let tileLayer;
      let layerControl;
      let currentBase = 'light'; // light | dark | satellite
      let currentLayer = null;
      let currentMarkers = [];
      let altitudeChart = null;
      let routes = [];
      let activeCategory = 'hiking';
      let showUpcomingRoutes = false;
      let lastRoute = null;

            lucide.createIcons();
      initTheme();
      initMap();
      loadRoutes();
      bindEvents();

      function initTheme() {
        const saved = localStorage.getItem('theme');
        if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          html.classList.add('dark');
        }
        updateThemeToggleIcon();
      }

      function bindEvents() {
        themeToggle.addEventListener('click', () => {
          html.classList.toggle('dark');
          localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
          updateThemeToggleIcon();
          updateTileLayer();
          if (currentLayer && lastRoute) {
            showRouteOnMap(lastRoute, { skipFit: true });
          }
        });

        searchInput.addEventListener('input', renderRoutes);

        tabButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            tabButtons.forEach(b => b.classList.remove('active', 'bg-white', 'shadow'));
            btn.classList.add('active', 'bg-white', 'shadow');
            activeCategory = btn.dataset.category;
            renderRoutes();
          });
        });

        const upcomingToggle = document.getElementById('upcomingToggle');
        const upcomingToggleThumb = document.getElementById('upcomingToggleThumb');
        upcomingToggle.addEventListener('click', () => {
          showUpcomingRoutes = !showUpcomingRoutes;
          upcomingToggle.setAttribute('aria-checked', showUpcomingRoutes);
          if (showUpcomingRoutes) {
            upcomingToggle.classList.remove('bg-zinc-200', 'dark:bg-zinc-700');
            upcomingToggle.classList.add('bg-zinc-600', 'dark:bg-zinc-500');
            upcomingToggleThumb.classList.remove('translate-x-1');
            upcomingToggleThumb.classList.add('translate-x-6');
          } else {
            upcomingToggle.classList.remove('bg-zinc-600', 'dark:bg-zinc-500');
            upcomingToggle.classList.add('bg-zinc-200', 'dark:bg-zinc-700');
            upcomingToggleThumb.classList.remove('translate-x-6');
            upcomingToggleThumb.classList.add('translate-x-1');
          }
          renderRoutes();
        });
      }

      function updateThemeToggleIcon() {
        const isDark = html.classList.contains('dark');
        themeToggle.innerHTML = isDark
          ? '<i data-lucide="moon" class="h-5 w-5 text-zinc-200"></i>'
          : '<i data-lucide="sun" class="h-5 w-5 text-zinc-700"></i>';
        lucide.createIcons({ root: themeToggle });
      }

      function initMap() {
        const baseLayers = {
          light: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }),
          dark: L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors, Stadia Maps'
          }),
          satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics, USDA, USGS, AeroGRID, IGN, GIS User Community'
          })
        };

        map = L.map('map', { zoomControl: false, layers: [baseLayers.light] }).setView(MAP_CENTER, 6);
        tileLayer = baseLayers.light;
        currentBase = 'light';

        layerControl = L.control.layers(
          {
            'Standard': baseLayers.light,
            'Dark': baseLayers.dark,
            'Satellite': baseLayers.satellite
          },
          {},
          { position: 'topright' }
        ).addTo(map);

        map.on('baselayerchange', (e) => {
          currentBase = e.name.toLowerCase();
          tileLayer = e.layer;
        });

        L.control.zoom({ position: 'bottomright' }).addTo(map);
      }

      function updateTileLayer() {
        const isDark = html.classList.contains('dark');
        const desired = currentBase === 'satellite'
          ? 'satellite'
          : isDark ? 'dark' : 'light';

        const layers = layerControl._layers;
        const match = Object.values(layers || {}).find(l => l.name && l.name.toLowerCase() === desired);
        if (match && match.layer && tileLayer !== match.layer) {
          map.addLayer(match.layer);
          if (tileLayer) map.removeLayer(tileLayer);
          tileLayer = match.layer;
          currentBase = desired;
        }
      }

        async function loadRoutes() {
            try {
          const res = await fetch(`${ROUTES_JSON}?_=${Date.now()}`);
          routes = await res.json();
                renderRoutes();
            } catch (err) {
          routesList.innerHTML = '<div class="rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm font-semibold text-rose-700 dark:border-rose-800 dark:bg-rose-950/40 dark:text-rose-200">Failed to load routes: ' + err.message + '</div>';
            }
        }

        function renderRoutes() {
        const term = searchInput.value.trim().toLowerCase();
        routesList.innerHTML = '';

        let filtered = routes.filter(r => {
          const matchesCategory = r.category === activeCategory;
          const matchesSearch = (r.name + ' ' + (r.description || '') + ' ' + r.file).toLowerCase().includes(term);
          const isUpcoming = r.upcoming === true;
          
          if (!showUpcomingRoutes && isUpcoming) {
            return false;
          }
          
          return matchesCategory && matchesSearch;
        });

        // Sort: upcoming routes first when enabled
        if (showUpcomingRoutes) {
          filtered.sort((a, b) => {
            const aUpcoming = a.upcoming === true;
            const bUpcoming = b.upcoming === true;
            if (aUpcoming && !bUpcoming) return -1;
            if (!aUpcoming && bUpcoming) return 1;
            return 0;
          });
        }

        if (!filtered.length) {
          routesList.innerHTML = '<div class="rounded-xl border border-zinc-200 bg-zinc-50 px-4 py-6 text-center text-sm text-zinc-600 dark:border-zinc-800 dark:bg-zinc-950 dark:text-zinc-300">No routes found.</div>';
                return;
            }

        filtered.forEach(route => {
          const card = document.createElement('article');
          const isUpcoming = route.upcoming === true;
          card.className = 'group rounded-xl border border-slate-200 bg-white p-4 shadow-sm transition hover:-translate-y-0.5 hover:border-zinc-300 hover:shadow-md dark:border-zinc-800 dark:bg-zinc-900';
          card.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <h3 class="text-base font-semibold text-zinc-900 dark:text-zinc-50">${escapeHtml(route.name)}</h3>
                  ${isUpcoming ? '<span class="inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-700 dark:bg-amber-900/30 dark:text-amber-300"><i data-lucide="calendar" class="h-3 w-3"></i>Upcoming</span>' : ''}
                </div>
                <p class="mt-1 text-sm text-zinc-600 dark:text-zinc-300">${escapeHtml(route.description || 'No description')}</p>
              </div>
              <span class="rounded-full bg-zinc-100 px-3 py-1 text-xs font-semibold text-zinc-700 dark:bg-zinc-800 dark:text-zinc-200">${route.category === 'hiking' ? 'Hiking' : 'Moto'}</span>
            </div>
            <div class="mt-3 flex flex-wrap items-center gap-2 text-xs text-zinc-500 dark:text-zinc-400">
              ${route.difficulty ? `<span class="inline-flex items-center gap-1 rounded-full bg-zinc-100 px-2 py-1 dark:bg-zinc-800"><i data-lucide="activity" class="h-3.5 w-3.5"></i>${escapeHtml(route.difficulty)}</span>` : ''}
              ${route.duration ? `<span class="inline-flex items-center gap-1 rounded-full bg-zinc-100 px-2 py-1 dark:bg-zinc-800"><i data-lucide="timer" class="h-3.5 w-3.5"></i>${escapeHtml(route.duration)}</span>` : ''}
              ${route.type ? `<span class="inline-flex items-center gap-1 rounded-full bg-zinc-100 px-2 py-1 dark:bg-zinc-800"><i data-lucide="repeat" class="h-3.5 w-3.5"></i>${escapeHtml(route.type)}</span>` : ''}
            </div>
            <div class="mt-4 flex flex-wrap gap-2">
              <button class="view-btn inline-flex items-center gap-2 rounded-lg bg-zinc-800 px-2.5 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-zinc-900 focus:outline-none focus:ring-2 focus:ring-zinc-300 focus:ring-offset-2 dark:bg-zinc-200 dark:text-zinc-900 dark:hover:bg-white dark:focus:ring-2 dark:focus:ring-zinc-400 dark:focus:ring-offset-2 dark:focus:ring-offset-zinc-950 sm:px-3 sm:py-2 sm:text-sm">
                <i data-lucide="map" class="h-4 w-4"></i>
                View on map
                        </button>
              <a class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-2.5 py-1.5 text-xs font-semibold text-zinc-700 shadow-sm transition hover:border-zinc-300 hover:text-zinc-800 focus:outline-none focus:ring-2 focus:ring-zinc-300 focus:ring-offset-2 dark:border-zinc-700 dark:bg-zinc-900 dark:text-zinc-200 dark:hover:border-zinc-400 dark:hover:text-zinc-50 dark:focus:ring-zinc-500 dark:focus:ring-offset-zinc-950 sm:px-3 sm:py-2 sm:text-sm" href="${GPX_FOLDER + encodeURIComponent(route.file)}" download>
                <i data-lucide="download" class="h-4 w-4"></i>
                            Download
                        </a>
            </div>
          `;

          card.querySelector('.view-btn').addEventListener('click', () => showRouteOnMap(route));
          routesList.appendChild(card);
          lucide.createIcons({ root: card });
        });
      }

      async function showRouteOnMap(route, options = {}) {
        lastRoute = route;
            if (!route.file) return;

            const url = GPX_FOLDER + route.file;
        detailText.textContent = `Loading ${route.name}...`;
        detailText.classList.add('animate-pulse');

            if (currentLayer) map.removeLayer(currentLayer);
            currentMarkers.forEach(m => map.removeLayer(m));
            currentMarkers = [];

            try {
                const resp = await fetch(url);
                const text = await resp.text();
          const xml = new DOMParser().parseFromString(text, 'application/xml');
                const geojson = toGeoJSON.gpx(xml);

          const isDark = html.classList.contains('dark');
                const routeColor = isDark ? '#38bdf8' : '#0ea5e9';

                currentLayer = L.geoJSON(geojson, {
            style: { color: routeColor, weight: 4, opacity: 0.85 }
                }).addTo(map);

          if (!options.skipFit) {
                map.fitBounds(currentLayer.getBounds(), { padding: [50, 50] });
          }

                const coords = geojson.features.flatMap(f => {
            if (f.geometry.type === 'LineString') return f.geometry.coordinates.map(c => [c[1], c[0], c[2] || 0]);
            if (f.geometry.type === 'MultiLineString') return f.geometry.coordinates.flat().map(c => [c[1], c[0], c[2] || 0]);
                    return [];
                });

                if (coords.length) {
                    const start = coords[0];
                    const end = coords[coords.length - 1];

                    const startIcon = L.divIcon({
              html: buildMarkerHtml('MapPin', 'S', 'from-emerald-500 to-emerald-600', '#10b981'),
                        iconSize: [48, 48],
                        iconAnchor: [24, 48],
              className: 'start-marker-icon'
                    });
            currentMarkers.push(
              L.marker([start[0], start[1]], { icon: startIcon })
                        .addTo(map)
                .bindPopup(`<strong class="text-emerald-600">Start:</strong> ${route.name}`)
            );

                    const endIcon = L.divIcon({
              html: buildMarkerHtml('Flag', 'F', 'from-rose-500 to-rose-600', '#ef4444'),
                        iconSize: [48, 48],
                        iconAnchor: [24, 48],
              className: 'finish-marker-icon'
                    });
            currentMarkers.push(
              L.marker([end[0], end[1]], { icon: endIcon })
                        .addTo(map)
                .bindPopup(`<strong class="text-rose-600">Finish:</strong> ${route.name}`)
            );

            const parkingCoords = normalizeParking(route.parking);
                        if (parkingCoords) {
                            const parkingIcon = L.divIcon({
                html: buildMarkerHtml('ParkingCircle', 'P', 'from-sky-500 to-sky-600', '#0ea5e9'),
                                iconSize: [48, 48],
                                iconAnchor: [24, 48],
                className: 'parking-marker-icon'
                            });
              currentMarkers.push(
                L.marker(parkingCoords, { icon: parkingIcon })
                                .addTo(map)
                  .bindPopup('<strong class="text-sky-600">Recommended parking</strong>')
              );
                    }
                }

                const altitudes = coords.map(c => c[2] || 0);
                renderAltitudeChart(altitudes);

          const distanceKm = computeDistanceKm(coords);
          detailText.classList.remove('animate-pulse');
          detailText.innerHTML = `
            <strong class="text-zinc-900 dark:text-zinc-50">${escapeHtml(route.name)}</strong><br>
            <span class="text-zinc-600 dark:text-zinc-300">${escapeHtml(route.description || '')}</span><br>
            <span class="text-xs text-zinc-500 dark:text-zinc-400"><strong>Distance:</strong> ${distanceKm.toFixed(2)} km</span>
          `;

          downloadWrap.innerHTML = `
            <a class="inline-flex items-center gap-2 rounded-lg bg-zinc-800 px-2.5 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-zinc-900 focus:outline-none focus:ring-2 focus:ring-zinc-300 focus:ring-offset-2 dark:bg-zinc-200 dark:text-zinc-900 dark:hover:bg-white dark:focus:ring-2 dark:focus:ring-zinc-400 dark:focus:ring-offset-2 dark:focus:ring-offset-[#0b0d12] sm:px-3 sm:py-2 sm:text-sm" href="${url}" download>
              <i data-lucide="download" class="h-4 w-4"></i>
              Download GPX
            </a>
          `;
          lucide.createIcons({ root: downloadWrap });
            } catch (err) {
          detailText.classList.remove('animate-pulse');
          detailText.innerHTML = `<span class="text-rose-600 dark:text-rose-400">Failed to load: ${escapeHtml(err.message)}</span>`;
        }
      }

      function buildMarkerHtml(iconName, badgeText, gradientClasses, accentColor) {
        const svgMap = {
          MapPin: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2"><path d="M12 21s-6-5.686-6-10a6 6 0 1 1 12 0c0 4.314-6 10-6 10Z"/><circle cx="12" cy="11" r="2.5" fill="white"/></svg>',
          Flag: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V5s-1 1-4 1-5-2-8-2-4 1-4 1Z"/><path d="M4 22V4"/><path d="M4 15V4"/></svg>',
          ParkingCircle: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M10 17V7h4a3 3 0 0 1 0 6h-4"/></svg>'
        };
        const svg = svgMap[iconName] || '';
        return `
          <div class="relative h-12 w-12">
            <div class="absolute inset-0 flex items-center justify-center rounded-full bg-gradient-to-br ${gradientClasses} shadow-xl ring-4 ring-white ring-opacity-70 dark:ring-slate-900">
              ${svg}
            </div>
            <div class="absolute -top-2 -right-2 flex h-6 w-6 items-center justify-center rounded-full bg-white text-[10px] font-bold text-zinc-800 shadow-sm ring-2 ring-white dark:bg-zinc-900 dark:text-zinc-100 dark:ring-zinc-900" style="color:${accentColor};">${badgeText}</div>
          </div>
        `;
      }

      function normalizeParking(parking) {
        if (!parking) return null;
        if (Array.isArray(parking) && parking.length === 2) return parking;
        if (typeof parking === 'object') {
          if (parking.lat !== undefined && parking.lng !== undefined) return [parking.lat, parking.lng];
          if (parking.latitude !== undefined && parking.longitude !== undefined) return [parking.latitude, parking.longitude];
        }
        return null;
        }

        function renderAltitudeChart(altitudes) {
            const ctx = document.getElementById('altitudeChart').getContext('2d');
            if (altitudeChart) altitudeChart.destroy();

        const isDark = html.classList.contains('dark');
            const lineColor = isDark ? '#38bdf8' : '#0ea5e9';
            const fillColor = isDark ? 'rgba(56,189,248,0.15)' : 'rgba(14,165,233,0.15)';
        const gridColor = isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)';

            const minAlt = Math.min(...altitudes);
            const maxAlt = Math.max(...altitudes);

            altitudeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: altitudes.map((_, i) => i),
                    datasets: [{
                        data: altitudes,
                        borderColor: lineColor,
                        backgroundColor: fillColor,
                        fill: true,
              tension: 0.35,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                  label: ctx => `${Math.round(ctx.parsed.y)} m`,
                  title: () => 'Altitudine'
                },
                backgroundColor: isDark ? 'rgba(15,23,42,0.95)' : 'rgba(255,255,255,0.95)',
                titleColor: isDark ? '#e2e8f0' : '#0f172a',
                            bodyColor: isDark ? '#cbd5e1' : '#475569',
                            borderColor: isDark ? '#334155' : '#e2e8f0',
                            borderWidth: 1,
                            padding: 8,
                            displayColors: false
                        }
                    },
                    scales: {
              x: { display: false },
                        y: {
                            position: 'right',
                            min: minAlt - (maxAlt - minAlt) * 0.1,
                            max: maxAlt + (maxAlt - minAlt) * 0.1,
                grid: { color: gridColor, drawBorder: false },
                            ticks: {
                                color: isDark ? '#94a3b8' : '#64748b',
                  font: { size: 10 },
                  callback: v => `${Math.round(v)} m`,
                                maxTicksLimit: 4
                            }
                        }
                    },
                    animation: false,
            interaction: { mode: 'index', intersect: false }
                }
            });
        }

      function computeDistanceKm(coords) {
        if (coords.length < 2) return 0;
        let total = 0;
        const R = 6371;
        for (let i = 1; i < coords.length; i++) {
          const a = coords[i - 1], b = coords[i];
          const dLat = (b[0] - a[0]) * Math.PI / 180;
          const dLon = (b[1] - a[1]) * Math.PI / 180;
          const lat1 = a[0] * Math.PI / 180, lat2 = b[0] * Math.PI / 180;
          const sinDLat = Math.sin(dLat / 2), sinDLon = Math.sin(dLon / 2);
          const aa = sinDLat * sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLon * sinDLon;
          total += 2 * R * Math.atan2(Math.sqrt(aa), Math.sqrt(1 - aa));
        }
        return total;
      }

      function escapeHtml(str) {
        return str ? str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])) : '';
      }
    });
</script>
</body>
</html>

