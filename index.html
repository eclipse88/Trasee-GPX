<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hiking & Moto Trails ‚Äì Petru & Ioana</title>
    <meta name="description" content="View and download GPX tracks ‚Äî Hiking and motorcycle routes with details">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --text-secondary: #475569;
            --muted: #64748b;
            --accent: #0ea5e9;
            --accent-hover: #0284c7;
            --accent-light: #e0f2fe;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius: 1rem;
            --radius-lg: 1.5rem;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
            --text-secondary: #cbd5e1;
            --muted: #94a3b8;
            --accent: #38bdf8;
            --accent-hover: #7dd3fc;
            --accent-light: #0c4a6e;
            --border: #334155;
            --success: #34d399;
            --danger: #f87171;
        }

        * { box-sizing: border-box; }

        html, body {
            height: 100%;
            margin: 0;
        }

        body {
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
        }

        header {
            text-align: center;
            padding: 1.5rem 1.5rem 1.25rem;
            position: relative;
            background: linear-gradient(135deg, var(--accent-light) 0%, var(--bg) 100%);
            border-bottom: 1px solid var(--border);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--card);
            box-shadow: var(--shadow-xl);
            flex-shrink: 0;
            transition: var(--transition);
        }

        .header-photo:hover {
            transform: scale(1.05) rotate(3deg);
        }

        header h1 {
            font-size: 2rem;
            font-weight: 800;
            margin: 0;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: var(--transition);
            white-space: nowrap;
            letter-spacing: -0.02em;
        }

        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: var(--transition);
            z-index: 100;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            border-color: var(--accent);
            box-shadow: var(--shadow-lg), 0 0 0 4px var(--accent-light);
        }

        .theme-toggle i {
            width: 28px;
            height: 28px;
            color: var(--text);
            transition: var(--transition);
        }

        .container {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
            flex: 1;
            overflow: hidden;
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
        }

        .sidebar {
            background: var(--card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            overflow: auto;
            transition: var(--transition);
            border: 1px solid var(--border);
        }

        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--muted);
        }

        .sidebar-header h2 {
            font-size: 1.375rem;
            margin: 0 0 0.375rem 0;
            color: var(--text);
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        .sidebar-header p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9375rem;
            line-height: 1.5;
        }

        .tabs {
            display: flex;
            background: var(--bg);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            padding: 4px;
            gap: 4px;
        }

        .tab {
            flex: 1;
            padding: 0.75rem 0.875rem;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: var(--transition);
            border-radius: calc(var(--radius) - 4px);
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .tab:hover {
            background: var(--card);
            color: var(--text);
        }

        .tab.active {
            background: var(--accent);
            color: #ffffff;
            box-shadow: var(--shadow);
        }

        .search {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--card);
            color: var(--text);
            font-size: 0.9375rem;
            transition: var(--transition);
            font-family: inherit;
        }

        .search::placeholder {
            color: var(--muted);
        }

        .search:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 0.875rem;
            flex: 1;
            overflow: auto;
        }

        .list::-webkit-scrollbar {
            width: 8px;
        }

        .list::-webkit-scrollbar-track {
            background: transparent;
        }

        .list::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .route {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 1.25rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            cursor: pointer;
        }

        .route:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent);
        }

        .route h3 {
            margin: 0 0 0.375rem;
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.01em;
        }

        .route p {
            margin: 0 0 0.875rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .actions {
            display: flex;
            gap: 0.625rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.5rem 0.875rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.8125rem;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            background: var(--accent);
            color: white;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            text-decoration: none;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: var(--bg);
            border: 2px solid var(--border);
            color: var(--text);
        }

        .btn.secondary:hover {
            background: var(--card);
            border-color: var(--accent);
            color: var(--accent);
        }

        .map-card {
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            background: var(--card);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            border: 1px solid var(--border);
        }

        #map {
            height: 450px;
            width: 100%;
        }

        #altitudeChart {
            height: 80px !important;
            max-height: 80px !important;
            width: 100%;
            background: var(--bg);
            border-top: 1px solid var(--border);
            display: block;
            position: relative;
        }

        .altitude-label {
            position: absolute;
            top: 8px;
            left: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--muted);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            background: var(--card);
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border);
        }

        .details {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.25rem;
            background: var(--card);
        }

        .details .info {
            color: var(--text-secondary);
            font-size: 0.9375rem;
            line-height: 1.6;
        }

        .details .info strong {
            color: var(--text);
            font-weight: 700;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 380px 1fr;
                gap: 1.25rem;
            }
        }

        @media (max-width: 980px) {
            .container {
                grid-template-columns: 1fr;
                gap: 1.25rem;
                padding: 1.25rem;
            }

            .sidebar {
                order: 2;
                max-height: 500px;
            }

            .map-card {
                order: 1;
            }

            #map {
                height: 400px;
            }

            header {
                padding: 1.25rem 1.25rem 1rem;
            }

            header h1 {
                font-size: 1.75rem;
            }

            .theme-toggle {
                top: 1rem;
                right: 1rem;
                width: 46px;
                height: 46px;
            }
        }

        @media (max-width: 768px) {
            .header-photo {
                display: none;
            }

            header h1 {
                font-size: 1.5rem;
                white-space: normal;
                text-align: center;
            }

            .container {
                padding: 1rem;
                gap: 1rem;
            }

            .sidebar {
                padding: 1.25rem;
                max-height: 450px;
            }

            #map {
                height: 350px;
            }

            .theme-toggle {
                top: 0.875rem;
                right: 0.875rem;
                width: 44px;
                height: 44px;
            }
        }

        @media (max-width: 640px) {
            header {
                padding: 2rem 1rem 1rem;
            }

            header h1 {
                font-size: 1.5rem;
                line-height: 1.3;
            }

            .sidebar {
                padding: 1.25rem;
                gap: 1.25rem;
            }

            .sidebar-header h2 {
                font-size: 1.25rem;
            }

            .route {
                padding: 1.25rem;
            }

            .route h3 {
                font-size: 1.125rem;
            }

            #map {
                height: 350px;
            }

            .details {
                padding: 1.25rem;
                gap: 1rem;
            }

            .btn {
                font-size: 0.8125rem;
                padding: 0.5rem 0.875rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0.75rem;
            }

            header {
                padding: 1.5rem 0.75rem 0.75rem;
            }

            header h1 {
                font-size: 1.25rem;
            }

            .theme-toggle {
                width: 44px;
                height: 44px;
                top: 0.75rem;
                right: 0.75rem;
            }

            #map {
                height: 300px;
            }
        }

        /* Animation pentru loading */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Marker animations */
        .start-marker-icon, .finish-marker-icon, .parking-marker-icon {
            animation: markerBounce 0.6s ease-out;
        }

        @keyframes markerBounce {
            0% { transform: translateY(-100px); opacity: 0; }
            50% { transform: translateY(10px); }
            100% { transform: translateY(0); opacity: 1; }
        }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>
    <div class="header-content">
        <img src="images/petru_ioana.jpeg" alt="Petru & Ioana" class="header-photo">
        <h1>Hiking & Motorcycling Adventures</h1>
        <img src="images/motorcycle.jpeg" alt="Motorcycle adventure" class="header-photo">
    </div>

    <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
        <i data-lucide="sun"></i>
    </button>
</header>

<div class="container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>Explore Routes</h2>
            <p>Curated hiking and motorcycle trails with detailed GPX tracks</p>
        </div>

        <div class="tabs">
            <div class="tab active" data-category="hiking">
                <i data-lucide="mountain"></i> Hiking
            </div>
            <div class="tab" data-category="moto">
                <i data-lucide="bike"></i> Moto
            </div>
        </div>

        <input id="search" class="search" placeholder="Search routes..." type="search">
        <div id="routesList" class="list"></div>
    </aside>

    <section class="map-card">
        <div id="map"></div>
        <div style="position:relative;">
            <div class="altitude-label">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                    <polyline points="17 6 23 6 23 12"></polyline>
                </svg>
                Elevation Profile
            </div>
            <canvas id="altitudeChart"></canvas>
        </div>
        <div class="details">
            <div class="info" id="detailText">Select a route to view details</div>
            <div id="downloadWrap"></div>
        </div>
    </section>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

<script>
    window.onload = function() {
        lucide.createIcons();

        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;

        function updateToggleIcon() {
            const isDark = body.classList.contains('dark');
            themeToggle.innerHTML = isDark
                ? '<i data-lucide="moon"></i>'
                : '<i data-lucide="sun"></i>';
            lucide.createIcons();
        }

        if (localStorage.getItem('theme') === 'dark' ||
            (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            body.classList.add('dark');
        }
        updateToggleIcon();

        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark');
            localStorage.setItem('theme', body.classList.contains('dark') ? 'dark' : 'light');
            updateToggleIcon();
        });

        const ROUTES_JSON = 'routes.json';
        const GPX_FOLDER = 'gpx/';
        let map = L.map('map').setView([45.9432, 24.9668], 6);

        const isDarkTheme = body.classList.contains('dark');
        const tileUrl = isDarkTheme
            ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
            : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

        L.tileLayer(tileUrl, {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let currentLayer = null;
        let currentMarkers = [];
        let ROUTES = [];
        let activeCategory = 'hiking';
        let altitudeChart = null;

        async function loadRoutes() {
            try {
                const res = await fetch(ROUTES_JSON + '?_=' + Date.now());
                ROUTES = await res.json();
                renderRoutes();
            } catch (err) {
                document.getElementById('routesList').innerHTML =
                    `<div style="color:var(--danger);padding:1rem;text-align:center;">Error loading routes: ${err.message}</div>`;
            }
        }

        function renderRoutes() {
            const container = document.getElementById('routesList');
            const search = document.getElementById('search').value.trim().toLowerCase();
            container.innerHTML = '';

            const filtered = ROUTES.filter(r =>
                r.category === activeCategory &&
                (r.name + ' ' + (r.description || '') + ' ' + r.file).toLowerCase().includes(search)
            );

            if (filtered.length === 0) {
                container.innerHTML = '<div style="color:var(--muted);padding:2rem;text-align:center;">No routes found</div>';
                return;
            }

            filtered.forEach(r => {
                const el = document.createElement('div');
                el.className = 'route';
                el.innerHTML = `
                    <h3>${escapeHtml(r.name)}</h3>
                    <p>${escapeHtml(r.description || 'No description available')}</p>
                    <div class="actions">
                        <button class="btn">
                            <i data-lucide="map" style="width:16px;height:16px;"></i>
                            View on Map
                        </button>
                        <a class="btn secondary" href="${GPX_FOLDER + encodeURIComponent(r.file)}" download>
                            <i data-lucide="download" style="width:16px;height:16px;"></i>
                            Download
                        </a>
                    </div>`;
                container.appendChild(el);
                el.querySelector('button').addEventListener('click', () => showRouteOnMap(r));
                lucide.createIcons();
            });
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                activeCategory = tab.dataset.category;
                renderRoutes();
            });
        });

        document.getElementById('search').addEventListener('input', renderRoutes);

        async function showRouteOnMap(route) {
            if (!route.file) return;
            const url = GPX_FOLDER + route.file;
            const detailEl = document.getElementById('detailText');
            detailEl.textContent = `Loading ${route.name}...`;
            detailEl.classList.add('loading');

            if (currentLayer) map.removeLayer(currentLayer);
            currentMarkers.forEach(m => map.removeLayer(m));
            currentMarkers = [];

            try {
                const resp = await fetch(url);
                const text = await resp.text();
                const xml = new DOMParser().parseFromString(text, "application/xml");
                const geojson = toGeoJSON.gpx(xml);

                const isDark = body.classList.contains('dark');
                const routeColor = isDark ? '#38bdf8' : '#0ea5e9';

                currentLayer = L.geoJSON(geojson, {
                    style: {
                        color: routeColor,
                        weight: 4,
                        opacity: 0.8
                    }
                }).addTo(map);

                map.fitBounds(currentLayer.getBounds(), { padding: [50, 50] });

                const coords = geojson.features.flatMap(f => {
                    if (f.geometry.type === 'LineString')
                        return f.geometry.coordinates.map(c => [c[1], c[0], c[2] || 0]);
                    if (f.geometry.type === 'MultiLineString')
                        return f.geometry.coordinates.flat().map(c => [c[1], c[0], c[2] || 0]);
                    return [];
                });

                if (coords.length) {
                    const start = coords[0];
                    const end = coords[coords.length - 1];

                    const startIcon = L.divIcon({
                        html: `
                            <div style="position:relative;width:48px;height:48px;">
                                <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:48px;height:48px;background:linear-gradient(135deg,#10b981,#059669);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(16,185,129,0.4),0 0 0 4px rgba(16,185,129,0.2);border:3px solid white;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                </div>
                                <div style="position:absolute;top:-8px;right:-8px;background:#10b981;color:white;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:11px;box-shadow:0 2px 8px rgba(0,0,0,0.3);border:2px solid white;">S</div>
                            </div>
                        `,
                        iconSize: [48, 48],
                        iconAnchor: [24, 48],
                        popupAnchor: [0, -50]
                    });
                    currentMarkers.push(L.marker([start[0], start[1]], { icon: startIcon })
                        .addTo(map)
                        .bindPopup(`<strong style="color:#10b981;">üöÄ Start:</strong> ${route.name}`));

                    const endIcon = L.divIcon({
                        html: `
                            <div style="position:relative;width:48px;height:48px;">
                                <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:48px;height:48px;background:linear-gradient(135deg,#ef4444,#dc2626);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(239,68,68,0.4),0 0 0 4px rgba(239,68,68,0.2);border:3px solid white;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                </div>
                                <div style="position:absolute;top:-8px;right:-8px;background:#ef4444;color:white;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:11px;box-shadow:0 2px 8px rgba(0,0,0,0.3);border:2px solid white;">F</div>
                            </div>
                        `,
                        iconSize: [48, 48],
                        iconAnchor: [24, 48],
                        popupAnchor: [0, -50]
                    });
                    currentMarkers.push(L.marker([end[0], end[1]], { icon: endIcon })
                        .addTo(map)
                        .bindPopup(`<strong style="color:#ef4444;">üèÅ Finish:</strong> ${route.name}`));

                    // Verificare »ôi adƒÉugare parking
                    console.log('Route parking data:', route.parking); // Debug

                    if (route.parking) {
                        let parkingCoords = null;

                        // VerificƒÉ dacƒÉ parking e array [lat, lng]
                        if (Array.isArray(route.parking) && route.parking.length === 2) {
                            parkingCoords = route.parking;
                        }
                        // VerificƒÉ dacƒÉ parking e object {lat, lng} sau {latitude, longitude}
                        else if (typeof route.parking === 'object') {
                            if (route.parking.lat !== undefined && route.parking.lng !== undefined) {
                                parkingCoords = [route.parking.lat, route.parking.lng];
                            } else if (route.parking.latitude !== undefined && route.parking.longitude !== undefined) {
                                parkingCoords = [route.parking.latitude, route.parking.longitude];
                            }
                        }

                        if (parkingCoords) {
                            console.log('Adding parking marker at:', parkingCoords); // Debug
                            const parkingColor = isDark ? '#38bdf8' : '#0ea5e9';
                            const parkingGradient = isDark ? 'linear-gradient(135deg,#38bdf8,#0284c7)' : 'linear-gradient(135deg,#0ea5e9,#0284c7)';
                            const parkingIcon = L.divIcon({
                                html: `
                                    <div style="position:relative;width:48px;height:48px;">
                                        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:48px;height:48px;background:${parkingGradient};border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(14,165,233,0.4),0 0 0 4px rgba(14,165,233,0.2);border:3px solid white;">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"></path>
                                                <path d="M9 7h4a3 3 0 0 1 0 6h-4V7z" fill="none"></path>
                                                <line x1="9" y1="7" x2="9" y2="17" stroke-width="2.5"></line>
                                            </svg>
                                        </div>
                                    </div>
                                `,
                                iconSize: [48, 48],
                                iconAnchor: [24, 48],
                                popupAnchor: [0, -50]
                            });
                            currentMarkers.push(L.marker(parkingCoords, { icon: parkingIcon })
                                .addTo(map)
                                .bindPopup(`<strong style="color:${parkingColor};">üÖøÔ∏è Recommended Parking</strong>`));
                        } else {
                            console.log('Invalid parking format:', route.parking);
                        }
                    }
                }

                const altitudes = coords.map(c => c[2] || 0);
                const distanceKm = computeDistanceKm(coords);

                renderAltitudeChart(altitudes);

                detailEl.classList.remove('loading');
                detailEl.innerHTML = `
                    <strong>${escapeHtml(route.name)}</strong><br>
                    ${escapeHtml(route.description || '')}<br>
                    <span style="font-size:0.875rem;color:var(--muted);">
                        <strong>Distance:</strong> ${distanceKm.toFixed(2)} km
                    </span>`;

                document.getElementById('downloadWrap').innerHTML = `
                    <a class="btn" href="${url}" download>
                        <i data-lucide="download" style="width:16px;height:16px;"></i>
                        Download
                    </a>`;
                lucide.createIcons();

            } catch (err) {
                detailEl.classList.remove('loading');
                detailEl.innerHTML = `<span style="color:var(--danger);">Error loading GPX: ${err.message}</span>`;
            }
        }

        function computeDistanceKm(coords) {
            if (coords.length < 2) return 0;
            let total = 0;
            const R = 6371;
            for (let i = 1; i < coords.length; i++) {
                const a = coords[i-1], b = coords[i];
                const dLat = (b[0] - a[0]) * Math.PI / 180;
                const dLon = (b[1] - a[1]) * Math.PI / 180;
                const lat1 = a[0] * Math.PI / 180, lat2 = b[0] * Math.PI / 180;
                const sinDLat = Math.sin(dLat/2), sinDLon = Math.sin(dLon/2);
                const aa = sinDLat*sinDLat + Math.cos(lat1)*Math.cos(lat2)*sinDLon*sinDLon;
                total += 2 * R * Math.atan2(Math.sqrt(aa), Math.sqrt(1 - aa));
            }
            return total;
        }

        function renderAltitudeChart(altitudes) {
            const ctx = document.getElementById('altitudeChart').getContext('2d');
            if (altitudeChart) altitudeChart.destroy();

            const isDark = body.classList.contains('dark');
            const lineColor = isDark ? '#38bdf8' : '#0ea5e9';
            const fillColor = isDark ? 'rgba(56,189,248,0.15)' : 'rgba(14,165,233,0.15)';
            const gridColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';

            const minAlt = Math.min(...altitudes);
            const maxAlt = Math.max(...altitudes);

            altitudeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: altitudes.map((_, i) => i),
                    datasets: [{
                        data: altitudes,
                        borderColor: lineColor,
                        backgroundColor: fillColor,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${Math.round(context.parsed.y)}m`;
                                },
                                title: function() {
                                    return 'Elevation';
                                }
                            },
                            backgroundColor: isDark ? 'rgba(30,41,59,0.95)' : 'rgba(255,255,255,0.95)',
                            titleColor: isDark ? '#f1f5f9' : '#0f172a',
                            bodyColor: isDark ? '#cbd5e1' : '#475569',
                            borderColor: isDark ? '#334155' : '#e2e8f0',
                            borderWidth: 1,
                            padding: 8,
                            displayColors: false
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: true,
                            position: 'right',
                            min: minAlt - (maxAlt - minAlt) * 0.1,
                            max: maxAlt + (maxAlt - minAlt) * 0.1,
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            },
                            ticks: {
                                color: isDark ? '#94a3b8' : '#64748b',
                                font: {
                                    size: 9
                                },
                                callback: function(value) {
                                    return Math.round(value) + 'm';
                                },
                                maxTicksLimit: 4
                            }
                        }
                    },
                    animation: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        function escapeHtml(s) {
            return s ? s.replace(/[&<>"']/g, m => ({
                '&':'&amp;',
                '<':'&lt;',
                '>':'&gt;',
                '"':'&quot;',
                "'":'&#39;'
            }[m])) : '';
        }

        loadRoutes();
    };
</script>
</body>
</html>